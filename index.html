<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PLANIFICACI√ìN DE EVENTOS</title>
  <link rel="icon" type="image/png" href="img/logo-tigre.png">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Select2 + tema Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css">

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/es.js"></script>

    <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { font-family: 'Roboto', 'Open Sans', Arial, sans-serif; background-color: #ffffff; color: #1D2B4F; }
    .logo-tigre { height: 60px; object-fit: contain; }
    .logo-unemi { height: 50px; object-fit: contain; }
    .franja-superior { background-color: #1D2B4F; color: white; font-size: 22px; font-weight: bold; }
    .franja-naranja { height: 10px; background-color: #F39200; }
    .titulo-seccion { background-color: #e5e5e5; font-weight: bold; padding: 10px 15px; border-radius: 6px; font-size: 16px; margin-bottom: 20px; }
    .table-wrapper { overflow-x: auto; }
  </style>
</head>
<body>

<div class="franja-superior d-flex justify-content-between align-items-center px-3">
  <div class="text-center flex-grow-1">
    <img src="img/logo-tigre.png" alt="Logo Tigre" class="logo-tigre">
    <h2 class="fw-bold m-2" style="color:white;">Planificaci√≥n de Eventos</h2>
  </div>
  <div class="d-flex align-items-center justify-content-end">
    <img src="img/logo-unemi.png" alt="Logo UNEMI" class="logo-unemi">
</div>
<div class="franja-naranja"></div>

<div class="container mt-4">
  <div class="form-narrow"><!-- TODO dentro va con el mismo ancho -->

    <form id="formularioEvento">
      <div class="titulo-seccion mb-3">DATOS SOLICITANTE</div>

    <!-- 2 campos por fila -->
      <div class="row g-3 align-items-end">
        <div class="col-12 col-lg-6">
         <label class="form-label fw-bold mb-1">Solicitante:</label>
          <input type="text" class="form-control" id="solicitante" placeholder="Ingrese el Nombre Completo" required>
        </div>

      <div class="col-12 col-lg-6">
        <label class="form-label fw-bold mb-1">Modalidad del evento:</label>
          <select class="form-select" id="modalidad" required>
            <option value="">Seleccione</option>
            <option value="Presencial" selected>Presencial</option>
            <option value="Virtual">Virtual</option>
            <option value="H√≠brido">H√≠brido</option>
         </select>
      </div>
  </div>

<div class="row g-3 align-items-end mt-0">
  <div class="col-12 col-lg-6">
    <label for="departamento" class="form-label fw-bold mb-1">Unidad acad√©mica o administrativa:</label>
    <select class="form-select" id="departamento" required style="width:100%;">
      <option value="">Seleccione una Unidad</option>
    </select>
  </div>

  <div class="col-12 col-lg-6">
    <label class="form-label fw-bold mb-1">Correo institucional:</label>
    <input type="email" class="form-control" id="correo" required>
  </div>
</div>


     
      <!-- Mismo ancho para el bloque inferior -->
      <div class="titulo-seccion d-flex justify-content-between align-items-center mt-4">
        DETALLE DE EVENTOS
        <button type="button" class="btn btn-outline-primary btn-sm" onclick="mostrarFormularioDetalle()">+ A√±adir evento</button>
      </div>

      <div class="table-wrapper">
        <table class="table table-bordered mt-4 text-center">
          <thead class="table-secondary">
            <tr>
              <th>Nombre Evento</th>
              <th>Categor√≠a</th>
              <th>Tipo Evento</th>
              <th>Modalidad</th><!-- NUEVA COLUMNA -->
              <th>Espacio</th>
              <th>Fecha Inicio</th>
              <th>Fecha Fin</th>
              <th>Hora Inicio</th>
              <th>Hora Fin</th>
              <th>Participantes</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaResumen"></tbody>
        </table>
      </div>

       <div id="contenedorBotonEnviar" class="text-end mt-4" style="display: none;">
  <button type="submit" class="btn btn-primary">Enviar solicitud</button>
</div>
    </form>

  </div>
</div>

<!-- Detalle fuera del form -->
<div id="detalleEvento" style="display:none;" class="container mt-4"></div>

<script>
// Tu URL del script se mantiene igual
const scriptURL = "https://script.google.com/macros/s/AKfycbwdPB0IAR_w5V2A-vqp3oPtbkARp4dIdda1akAVu34XtlTx5DnVfEKS9GrJfsufXqf0VQ/exec"
//"https://script.google.com/macros/s/AKfycbzcNVXUXEa0GPt_A-FEXi-Mol3tPgTjR2onS_rXqFyNqFVmbw3_tJWn0nbfBSnf-BwoFA/exec";

// Estructuras de datos originales
const tiposPorCategoria = {
  "Eventos Solemnes": [
    "Sesi√≥n Solemne de Aniversario Institucional",
    "Audiencia P√∫blica de Rendici√≥n de Cuentas, dispuesta por el Consejo de Participaci√≥n Ciudadana y Control Social",
    "Aniversario de fundaci√≥n de las facultades",
    "Ceremonias de graduaci√≥n de grado y posgrado",
    "Ceremonia Honoris Causa"
  ],
  "Eventos Institucionales": [
    "Congresos, seminarios, simposios, encuentros, foros, talleres o jornadas, entre otros.",
    "Socializaci√≥n de planes de las unidades organizacionales",
    "Ceremonia de bienvenida al inicio de periodo acad√©mico",
    "Casas abiertas de las facultades",
    "Socializaci√≥n de resultados de actividades y/o proyectos de vinculaci√≥n e investigaci√≥n",
    "Entrega de Reconocimiento por rendimiento acad√©mico",
    "Inauguraci√≥n de obras",
    "Momento C√≠vico"
  ],
  "Eventos Interinstitucionales": ["Firma de convenios interinstitucionales y/o de cooperaci√≥n interinstitucional","Eventos que sean organizados por otras instituciones"],
  "Eventos Culturales": ["Ferias emprendedoras", "Festival Internacional de Teatro Uniendo Pueblos FITUP", "Novatada Cultural Institucional"]
};

// ===== CAMBIO 1: ESTRUCTURA DE DATOS PARA VALIDACI√ìN =====
// Objeto que define qu√© eventos se permiten en cada espacio.
// Las claves (nombres de los espacios) est√°n en min√∫sculas para una comparaci√≥n robusta.
  const eventosPorEspacio = {
  "Auditorio W": [
    "Sesi√≥n Solemne de Aniversario Institucional", "Audiencia P√∫blica de Rendici√≥n de Cuentas", "Aniversario de fundaci√≥n de las facultades",
    "Ceremonia Honoris Causa", "Ceremonias de graduaci√≥n de grado y posgrado", "Congresos", "Socializaci√≥n",
    "Entrega de Reconocimiento", "Firma de convenios", "Momento C√≠vico", "Festival Internacional de Teatro Uniendo Pueblos FITUP", "Eventos que sean organizados por otras instituciones",

  ],

  "Plazoleta": ["Ceremonia de bienvenida al inicio de periodo acad√©mico", "Festival Internacional de Teatro Uniendo Pueblos FITUP", "Casas abiertas de las facultades"],

  "√Ågora del Corredor Cultural": ["Ferias emprendedoras", "Festival Internacional de Teatro Uniendo Pueblos FITUP", "Novatada Cultural Institucional", "Casas abiertas de las facultades"],

  "Auditorio V": ["Congresos", "Socializaci√≥n", "Entrega de Reconocimiento"],

  "Auditorio A": ["Congresos", "Socializaci√≥n", "Festival Internacional de Teatro Uniendo Pueblos FITUP","Entrega de Reconocimiento"],

  "Plaza de Integraci√≥n": ["Ceremonia de bienvenida al inicio de periodo acad√©mico", "Casas abiertas de las facultades","Ferias emprendedoras", "Festival Internacional de Teatro Uniendo Pueblos FITUP","Novatada Cultural Institucional"]
};
// ===== CAMBIO 1: INVERTIR LA ESTRUCTURA DE DATOS PARA FILTRADO R√ÅPIDO =====
// Creamos una nueva estructura (Evento -> Espacios) a partir de la anterior.
// Esto nos permitir√° encontrar los espacios v√°lidos para un evento de forma muy eficiente.
const espaciosPorEvento = {};
for (const espacio in eventosPorEspacio) {
    // Obtenemos el nombre del espacio con la capitalizaci√≥n correcta para mostrar al usuario.
    const nombreEspacioCorrecto = espacio.charAt(0).toUpperCase() + espacio.slice(1).replace(/ a$/, " A").replace(/ v$/, " V").replace(/ w$/, " W");
    eventosPorEspacio[espacio].forEach(eventoBase => {
        const eventoNormalizado = eventoBase.trim().toLowerCase();
        if (!espaciosPorEvento[eventoNormalizado]) {
            espaciosPorEvento[eventoNormalizado] = [];
        }
        espaciosPorEvento[eventoNormalizado].push(nombreEspacioCorrecto);
    });
}
// A√ëADIR DATOS DE CAPACIDAD M√ÅXIMA  
// =================================

const capacidadesMaximas = {
  "Auditorio A": 234,
  "Auditorio V": 117,
  "Auditorio W": 336,
  "√Ågora del Corredor Cultural": 400,
  "Plazoleta": 500,
  "Plaza de Integraci√≥n": 300 // Aseg√∫rate de que el nombre coincida (¬øIntegraci√≥n?)
};

// Variables globales
let eventos = [];
let editarIndex = -1;

// === Unidades (global) ===
const unidades = [
  {"codigo":1,"text":"Direcci√≥n de Planificaci√≥n Institucional"},
  {"codigo":2,"text":"Direcci√≥n de Aseguramiento de la Calidad"},
  {"codigo":3,"text":"Secretar√≠a General"},
  {"codigo":4,"text":"Direcci√≥n de Tecnolog√≠a de la Informaci√≥n y Comunicaciones"},
  {"codigo":5,"text":"Direcci√≥n de Operaciones Tecnol√≥gicas y de Laboratorios"},
  {"codigo":6,"text":"Direcci√≥n Administrativa"},
  {"codigo":7,"text":"Direcci√≥n de Seguridad Inform√°tica"},
  {"codigo":8,"text":"Direcci√≥n de Talento Humano"},
  {"codigo":9,"text":"Direcci√≥n de Bienestar Universitario"},
  {"codigo":10,"text":"Procuradur√≠a"},
  {"codigo":11,"text":"Auditor√≠a Interna"},
  {"codigo":12,"text":"Direcci√≥n Jur√≠dica"},
  {"codigo":13,"text":"Direcci√≥n de Comunicaci√≥n Institucional"},
  {"codigo":14,"text":"Centro de Estudios Estad√≠sticos de la UNEMI"},
  {"codigo":15,"text":"Direcci√≥n Financiera"},
  {"codigo":16,"text":"Direcci√≥n de Mantenimientos Menores y Servicios Generales"},
  {"codigo":17,"text":"Direcci√≥n de Obras Universitarias"},
  {"codigo":18,"text":"Centro de Recursos para el Aprendizaje y la Investigaci√≥n"},
  {"codigo":19,"text":"Direcci√≥n de Relaciones Interinstitucionales"},
  {"codigo":20,"text":"Direcci√≥n e Sedes Extenciones y Centros de Apoyo"},
  {"codigo":21,"text":"Facultad de Vinculaci√≥n"},
  {"codigo":22,"text":"Escuela de Formaci√≥n y Emprendimiento"},
  {"codigo":23,"text":"Direcci√≥n de Servicios Administrativos"},
  {"codigo":24,"text":"Direcci√≥n de Espacios de Simulaci√≥n"},
  {"codigo":25,"text":"Centro para la Formaci√≥n y Promoci√≥n del Deporte Universitario"},
  {"codigo":26,"text":"Consultorio Jur√≠dico Gratuito de la UNEMI"},
  {"codigo":27,"text":"Facultad de Investigaci√≥n"},
  {"codigo":28,"text":"Escuela de Formaci√≥n en Investigaci√≥n"},
  {"codigo":29,"text":"Facultad de Posgrados"},
  {"codigo":30,"text":"Escuela de Negocios"},
  {"codigo":31,"text":"Escuela de Educaci√≥n"},
  {"codigo":32,"text":"Escuela de Ciencias e Ingenier√≠as"},
  {"codigo":33,"text":"Escuela de Salud"},
  {"codigo":34,"text":"Escuela de Derecho"},
  {"codigo":35,"text":"Escuela de Doctorados"},
  {"codigo":36,"text":"Direcci√≥n de Gesti√≥n y Servicios Acad√©micos"},
  {"codigo":37,"text":"Direcci√≥n de Evaluaci√≥n y Perfeccionamiento Acad√©mico"},
  {"codigo":38,"text":"Direcci√≥n de Innovaci√≥n y Procesos Acad√©micos"},
  {"codigo":39,"text":"Facultad de Ciencias e Ingenier√≠as"},
  {"codigo":40,"text":"Facultad de Ciencias Sociales, Educaci√≥n Comercial y Derecho"},
  {"codigo":41,"text":"Facultad de Salud y Servicios Sociales"},
  {"codigo":42,"text":"Facultad de Educaci√≥n"},
  {"codigo":43,"text":"Rectorado"},
  {"codigo":44,"text":"Vicerrectorado de Vinculaci√≥n"},
  {"codigo":45,"text":"Vicerrectorado de Investigaci√≥n y de Posgrado"},
  {"codigo":46,"text":"Vicerrectorado Acad√©mico de Formaci√≥n de Grado"}

];

// === Carga e inicializa Select2 ===
function cargarUnidades() {
  const select = document.getElementById('departamento');
  // opciones base
  select.innerHTML = '<option value="">Seleccione una Unidad</option>';
  unidades.forEach(u => {
    const opt = document.createElement('option');
    opt.value = u.text;
    opt.textContent = u.text;
    select.appendChild(opt);
  });

  // (re)inicializar Select2
  if ($(select).hasClass('select2-hidden-accessible')) {
    $(select).select2('destroy');
  }

 // NUEVO C√ìDIGO (DESPU√âS)
$('#departamento').select2({
  theme: 'bootstrap-5',
  width: '100%',
  placeholder: 'Seleccione o escriba una Unidad', // Placeholder actualizado
  allowClear: true,
  language: 'es',
  tags: true // ¬°ESTA ES LA L√çNEA M√ÅGICA!
  });
}

 function actualizarEspaciosDisponibles(espacioSeleccionadoPreviamente = "") {
    const tipoEventoSeleccionado = document.getElementById("tipo_evento").value;
    const espacioSelect = document.getElementById("espacio");

     // üîπ Modalidad Virtual: no aplica espacio
  if (esVirtual()) {
    espacioSelect.innerHTML = '<option value="">No aplica (evento virtual)</option>';
    espacioSelect.disabled = true;
    return;
  }

    // üîπ Modalidad Presencial o H√≠brido: aplica espacios
  if (esPresencialOHibrido()) {
    // (el resto de la l√≥gica actual ya funciona igual que para Presencial)
  }
    // Si no se ha seleccionado un tipo de evento, vaciar y deshabilitar el combo de espacios.
    if (!tipoEventoSeleccionado) {
        espacioSelect.innerHTML = '<option value="">Seleccione primero un Tipo de Evento</option>';
        espacioSelect.disabled = true;
        return;
    }

    const tipoEventoNormalizado = tipoEventoSeleccionado.toLowerCase();
    let espaciosValidos = [];

    // Buscamos la regla que coincida con el evento seleccionado.
    for (const eventoBase in espaciosPorEvento) {
        if (tipoEventoNormalizado.includes(eventoBase)) {
            espaciosValidos = espaciosPorEvento[eventoBase];
            break; // Encontramos la regla, salimos del bucle.
        }
    }

    if (espaciosValidos.length > 0) {
        // Creamos las nuevas opciones HTML.
        const opcionesHTML = espaciosValidos
            .map(e => `<option value="${e}">${e}</option>`)
            .join("");
        espacioSelect.innerHTML = `<option value="">Seleccione un espacio</option>${opcionesHTML}`;
        espacioSelect.disabled = false;

        // Si se pas√≥ un valor para preseleccionar (modo edici√≥n), lo seleccionamos.
        if (espacioSeleccionadoPreviamente) {
            espacioSelect.value = espacioSeleccionadoPreviamente;
        }
    } else {
        // Si no se encontraron espacios v√°lidos para este evento.
        espacioSelect.innerHTML = '<option value="">No hay espacios disponibles para este evento</option>';
        espacioSelect.disabled = true;
    }
}

function actualizarCapacidadParticipantes() {
    const espacioSelect = document.getElementById("espacio");
    const participantesInput = document.getElementById("participantes");
    const espacioSeleccionado = espacioSelect.value;

  // üîπ Modalidad Virtual: habilitado y sin l√≠mite
  if (esVirtual()) {
    participantesInput.disabled = false;
    participantesInput.placeholder = 'Ingrese n√∫mero de participantes (sin l√≠mite)';
    participantesInput.removeAttribute('max');
    return;
  } 


  // üîπ Modalidad Presencial o H√≠brido
  if (esPresencialOHibrido()) {
    // ya tienes la l√≥gica que depende del espacio seleccionado
  }
    // Limpiamos el valor anterior
    participantesInput.value = '';

    if (espacioSeleccionado && capacidadesMaximas[espacioSeleccionado]) {
        const capacidad = capacidadesMaximas[espacioSeleccionado];
        
        // Habilitamos el campo
        participantesInput.disabled = false;
        
        // Actualizamos el placeholder como en tu imagen de ejemplo
        participantesInput.placeholder = `M√°ximo permitido: ${capacidad}`;
        
        // Establecemos el atributo 'max' para la validaci√≥n nativa del navegador
        participantesInput.max = capacidad;
    } else {
        // Si no se ha seleccionado un espacio v√°lido, lo deshabilitamos
        participantesInput.disabled = true;
        participantesInput.placeholder = 'Seleccione un espacio primero';
        participantesInput.removeAttribute('max'); // Quitamos el l√≠mite
    }
}

function validarParticipantesEnVivo(input) {
    // Obtenemos la referencia al div donde mostraremos el error.
    const errorDiv = document.getElementById('error-participantes');

    // Si por alguna raz√≥n no existe el div, salimos para evitar errores.
    if (!errorDiv) return;

    const numeroIngresado = parseInt(input.value, 10);
    const capacidadMaxima = parseInt(input.max, 10);

    // Verificamos si hay un valor ingresado y si es un n√∫mero v√°lido.
    if (!isNaN(numeroIngresado) && !isNaN(capacidadMaxima)) {
        if (numeroIngresado > capacidadMaxima) {
            // Si el n√∫mero es mayor al m√°ximo, mostramos el mensaje de error.
            errorDiv.textContent = `El m√°ximo permitido es ${capacidadMaxima}.`;
            // Opcional: a√±ade una clase para resaltar el borde del input en rojo
            input.classList.add('is-invalid');
        } else {
            // Si el n√∫mero es v√°lido (menor o igual al m√°ximo), borramos el mensaje.
            errorDiv.textContent = '';
            // Y quitamos la clase de error del input
            input.classList.remove('is-invalid');
        }
    } else {
        // Si el campo est√° vac√≠o o no es un n√∫mero, tambi√©n borramos el mensaje.
        errorDiv.textContent = '';
        input.classList.remove('is-invalid');
    }
} 

function mostrarFormularioDetalle(index = -1) {
  // ===== A√ëADIR ESTA L√çNEA AQU√ç =====
  // Oculta el bot√≥n principal 'Enviar solicitud' mientras se edita/a√±ade un evento.
  document.getElementById("contenedorBotonEnviar").style.display = "none";

  editarIndex = index;
  const evento = eventos[index] || {};

  const opcionesCategorias = Object.keys(tiposPorCategoria)
    .map(cat => `<option value="${cat}" ${evento.categoria === cat ? "selected" : ""}>${cat}</option>`)
    .join("");

    // El combo de espacios ahora se genera vac√≠o, se llenar√° din√°micamente.
    document.getElementById('detalleEvento').innerHTML = `
        <div class="titulo-seccion">DETALLE DEL EVENTO</div>
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Categor√≠a</label>
            <select class="form-select" id="categoria" onchange="actualizarTipoEvento()" required>
              <option value="">Seleccione</option>
              ${opcionesCategorias}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Tipo Evento</label>
            <!-- ===== CAMBIO 3: INTEGRACI√ìN - Se llama a la nueva funci√≥n al cambiar el tipo de evento ===== -->
            <select class="form-select" id="tipo_evento" required onchange="manejarVisibilidadFechaHora(); actualizarEspaciosDisponibles();"></select>
          </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Nombre Evento</label>
                <input type="text" class="form-control" id="nombre_evento" value="${evento.nombre_evento || ''}" required>
            </div>
           <div class="col-md-6">
            <label class="form-label">Alcance</label>
            <select class="form-select" id="alcance" required>
                <option value="">Seleccione</option>
                <option value="Nacional" ${evento.alcance === 'Nacional' ? 'selected' : ''}>Nacional</option>
                <option value="Internacional" ${evento.alcance === 'Internacional' ? 'selected' : ''}>Internacional</option>
            </select>
          </div>            
        </div>
      
        <div class="row mb-3">
         <div class="col-md-6">
          <label class="form-label">Nombre Espacio</label>
            <!-- PASO 3.1: Se a√±ade onchange para llamar a la nueva funci√≥n -->
            <select class="form-select" id="espacio" required disabled onchange="actualizarCapacidadParticipantes()">
            <option value="">Seleccione primero un Tipo de Evento</option>
            </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">N√∫mero de participantes:</label>
            <!-- PASO 3.2: Se inicia deshabilitado, se a√±ade placeholder y min="1" -->
            <input type="number" class="form-control" id="participantes" value="${evento.participantes || ''}" 
               placeholder="Seleccione un espacio primero" min="1" disabled required oninput="validarParticipantesEnVivo(this)">
          <div id="error-participantes" class="form-text text-danger"></div>
        </div>
      </div>

        <div class="row mb-3" id="contenedorFechasHoras">
      <div class="col-md-3">
        <label class="form-label">Fecha Inicio</label>
        <input type="date" class="form-control" id="inicio_reserva" value="${evento.inicio_reserva || ''}" required onchange="validarFechasInicio()">
      </div>
      <div class="col-md-3">
        <label class="form-label">Fecha Fin</label>
        <input type="date" class="form-control" id="fin_reserva" value="${evento.fin_reserva || ''}" required onchange="validarFechasFin()">
      </div>
      <div class="col-md-3">
        <label class="form-label">Hora Inicio</label>
        <input type="time" class="form-control" id="hora_inicio" value="${evento.hora_inicio || ''}" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">Hora Fin</label>
        <input type="time" class="form-control" id="hora_fin" value="${evento.hora_fin || ''}" required>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-12">
        <label class="form-label">Descripci√≥n</label>
        <textarea class="form-control" id="objeto_reserva" rows="2">${evento.objeto_reserva || ''}</textarea>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Responsable del evento</label>
        <input type="text" class="form-control" id="responsable_espacio" value="${evento.responsable_espacio || ''}" placeholder="Ingrese el nombre completo" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Celular</label>
        <input type="tel" class="form-control" id="celular" value="${evento.celular ? evento.celular.replace(/'/g, '') : ''}" pattern="[0-9]{10}" maxlength="10" title="El n√∫mero de celular debe contener 10 d√≠gitos." required inputmode="numeric">
      </div>
    </div>

    <!-- ========================================================== -->
    <!--          NUEVO BLOQUE DE T√âRMINOS Y CONDICIONES          -->
    <!-- ========================================================== -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="terminos" required/>
            <label class="form-check-label texto-mediano" for="terminos">
        Acepto los 
        <a href="https://docs.google.com/document/d/1PNRoHcDD0k8BwewJDjTy6VdTOtCmurF_/edit?usp=drive_link&ouid=110049633757378533995&rtpof=true&sd=true"
           target="_blank" rel="noopener noreferrer">
          T√©rminos y Condiciones
        </a>
        y el 
        <a href="https://drive.google.com/file/d/1nQ1PjQqttC3Ho_ONk7p7AFIMt6Ok3NWL/view?usp=drive_link"
           target="_blank" rel="noopener noreferrer">
          Protocolo para el Desarrollo de Eventos
        </a>.
      </label>
       <div class="form-text">
        Debe aceptar esta casilla para poder enviar la solicitud.
        </div>
      </div>
    </div>
    <div class="text-end">
      <button type="button" class="btn btn-secondary" onclick="cancelarDetalle()">Cancelar</button>
      <button type="button" class="btn btn-success" onclick="guardarEvento()">Guardar Evento</button>
    </div>
  `;
  
  document.getElementById('celular').addEventListener('input', function (e) { this.value = this.value.replace(/[^0-9]/g, ''); });
  
  document.getElementById("detalleEvento").style.display = "block";

    // Llenamos el combo de tipo de evento y LUEGO actualizamos los espacios disponibles
    actualizarTipoEvento(evento.tipo_evento || "");
    actualizarEspaciosDisponibles(evento.espacio || "");
    actualizarCapacidadParticipantes();
    
    // üîπ NUEVO: aplica modalidad inmediatamente y escucha cambios
    aplicarModalidadEnDetalle();
    document.getElementById('modalidad').addEventListener('change', () => {
    aplicarModalidadEnDetalle();
});
}
  function actualizarTipoEvento(seleccionada = "") {
  const categoriaSel = document.getElementById("categoria").value;
  const tipo_evento = document.getElementById("tipo_evento");
  if (!tipo_evento) return;

  let opcionesLista = [];

  if (esVirtual()) {
    // En virtual, usar SOLO los tipos permitidos de la categor√≠a actualmente elegida
    const cat = categoriaSel || (obtenerCategoriasPermitidasVirtual()[0] || "");
    const tiposPermitidos = obtenerTiposPermitidosVirtualPorCategoria(cat);
    opcionesLista = tiposPermitidos;
  } else {
    // Presencial o H√≠brido: usa normalmente los tipos por categor√≠a global
    if (!categoriaSel) {
      tipo_evento.innerHTML = `<option value="">Seleccione</option>`;
      return;
    }
    opcionesLista = (tiposPorCategoria[categoriaSel] || []);
  }

  const opcionesHTML = opcionesLista
    .map(e => `<option value="${e}" ${e === seleccionada ? "selected" : ""}>${e}</option>`)
    .join("");

  tipo_evento.innerHTML = `<option value="">Seleccione</option>${opcionesHTML}`;

  manejarVisibilidadFechaHora();
  actualizarEspaciosDisponibles();
}


// Ya no necesitamos la validaci√≥n aqu√≠ porque el usuario no puede cometer el error.
function guardarEvento() {

       const participantesInput = document.getElementById('participantes');
    const numParticipantes = parseInt(participantesInput.value, 10);
    const capacidadMaxima = parseInt(participantesInput.max, 10);

    if (!isNaN(numParticipantes) && !isNaN(capacidadMaxima) && numParticipantes > capacidadMaxima) {
        Swal.fire({
            icon: 'error',
            title: 'Capacidad Excedida',
            text: `El n√∫mero de participantes (${numParticipantes}) no puede ser mayor que el m√°ximo permitido de ${capacidadMaxima} para este espacio.`
        });
        return; // Detiene la ejecuci√≥n de la funci√≥n
    } 

const chkTerminos = document.getElementById('terminos');
if (!chkTerminos || !chkTerminos.checked) {
  Swal.fire({
    icon: 'warning',
    title: 'Debe aceptar los T√©rminos y Condiciones',
    text: 'Marque la casilla "Acepto los T√©rminos y Condiciones" para continuar.'
  });
  return;
}
  const celularInput = document.getElementById("celular");
  const celularRegex = /^[0-9]{10}$/;

  if (!celularRegex.test(celularInput.value)) {
    Swal.fire({ icon: 'error', title: 'Celular no v√°lido', text: 'Por favor, ingrese un n√∫mero de celular que contenga exactamente 10 d√≠gitos.' });
    celularInput.focus();
    return;
  }
  if (esVirtual()) {
  const cat = document.getElementById("categoria").value;
  const tipo = document.getElementById("tipo_evento").value;
  const catsPerm = obtenerCategoriasPermitidasVirtual();
  const tiposPerm = obtenerTiposPermitidosVirtualPorCategoria(cat);

  if (!catsPerm.includes(cat) || !tiposPerm.includes(tipo)) {
    Swal.fire({
      icon: 'error',
      title: 'Tipo no permitido en modalidad Virtual',
      text: 'En modalidad Virtual solo se permiten categor√≠as y tipos definidos para ‚ÄúEventos Institucionales‚Äù y ‚ÄúEventos Solemnes‚Äù.'
    });
    return;
  }
}
   
  // La validaci√≥n de espacio ya no es necesaria aqu√≠.
  const evento = {
    categoria: document.getElementById("categoria").value,
    tipo_evento: document.getElementById("tipo_evento").value,
    nombre_evento: document.getElementById("nombre_evento").value,
    modalidad: document.getElementById("modalidad").value, // üîπ NUEVO
    espacio: document.getElementById("espacio").value,
    inicio_reserva: document.getElementById("inicio_reserva").value,
    hora_inicio: document.getElementById("hora_inicio").value,
    fin_reserva: document.getElementById("fin_reserva").value,
    hora_fin: document.getElementById("hora_fin").value,
    participantes: document.getElementById("participantes").value,
    alcance: document.getElementById("alcance").value,
    objeto_reserva: document.getElementById("objeto_reserva").value,
    responsable_espacio: document.getElementById("responsable_espacio").value,
    celular: "'" + celularInput.value 
  };

  if (editarIndex >= 0) {
    eventos[editarIndex] = evento;
  } else {
    eventos.push(evento);
  }

  document.getElementById("detalleEvento").style.display = "none";
  document.getElementById("detalleEvento").innerHTML = "";
  mostrarTablaResumen();

    // ===== A√ëADIR ESTA L√çNEA AQU√ç =====
  // Si hay al menos un evento en la lista, muestra el bot√≥n de enviar.
  if (eventos.length > 0) {
    document.getElementById("contenedorBotonEnviar").style.display = "block";
  }
}


function cancelarDetalle() {
    document.getElementById("detalleEvento").style.display = "none";
     // ===== A√ëADIR ESTA L√ìGICA AQU√ç =====
    // Al cancelar, tambi√©n se debe mostrar el bot√≥n de enviar si hay eventos en la lista.
    if (eventos.length > 0) {
      document.getElementById("contenedorBotonEnviar").style.display = "block";
    }
}

function validarFechasInicio() {
  const fechaInicioInput = document.getElementById('inicio_reserva');
  const fechaFinInput = document.getElementById('fin_reserva');
  const fechaInicio = fechaInicioInput.value;

  if (fechaInicio) {
    // Establece la fecha m√≠nima seleccionable en el campo de fecha fin.
    fechaFinInput.min = fechaInicio;

    // Si ya hab√≠a una fecha fin seleccionada y es menor que la nueva fecha de inicio, la borramos.
    if (fechaFinInput.value && fechaFinInput.value < fechaInicio) {
      fechaFinInput.value = ''; // Limpia el valor inv√°lido
    }
  } else {
    // Si se borra la fecha de inicio, quitamos la restricci√≥n de la fecha fin.
    fechaFinInput.min = '';
  }
}

/**
 * Funci√≥n que se activa al cambiar la Fecha de Fin.
 * Muestra una alerta si la fecha de fin es anterior a la de inicio.
 */
function validarFechasFin() {
  const fechaInicioInput = document.getElementById('inicio_reserva');
  const fechaFinInput = document.getElementById('fin_reserva');
  const fechaInicio = fechaInicioInput.value;
  const fechaFin = fechaFinInput.value;

  // Solo validamos si ambas fechas tienen un valor.
  if (fechaInicio && fechaFin) {
    // new Date() convierte el string 'YYYY-MM-DD' a un objeto de fecha comparable.
    if (new Date(fechaFin) < new Date(fechaInicio)) {
      Swal.fire({
        icon: 'error',
        title: 'Fecha Incorrecta',
        text: 'La fecha de fin no puede ser anterior a la fecha de inicio.'
      });
      // Limpiamos el campo de fecha fin para forzar al usuario a elegir una fecha v√°lida.
      fechaFinInput.value = '';
    }
  }
}

  function esVirtual() {
  const sel = document.getElementById('modalidad');
  return sel && sel.value === 'Virtual';
}
function esPresencialOHibrido() {
  const sel = document.getElementById('modalidad');
  return sel && (sel.value === 'Presencial' || sel.value === 'H√≠brido');
}


// Aplica el comportamiento de modalidad (habilitar/deshabilitar campos en el DETALLE)

function aplicarModalidadEnDetalle() {
  const espacioSelect = document.getElementById("espacio");
  const participantesInput = document.getElementById("participantes");
  const categoriaSelect = document.getElementById("categoria");
  const tipoEventoSelect = document.getElementById("tipo_evento");

  if (!espacioSelect || !participantesInput || !categoriaSelect || !tipoEventoSelect) return;

  if (esVirtual()) {
    // 1) Limitar categor√≠as a las permitidas en virtual y habilitar selecci√≥n
    const catsPerm = obtenerCategoriasPermitidasVirtual();
    categoriaSelect.innerHTML = `<option value="">Seleccione</option>` +
      catsPerm.map(c => `<option value="${c}">${c}</option>`).join("");
    categoriaSelect.disabled = false;

    // Si la categor√≠a actual no es v√°lida, preselecciona la primera
    if (!catsPerm.includes(categoriaSelect.value)) {
      categoriaSelect.value = catsPerm[0];
    }

    // 2) Cargar tipos seg√∫n la categor√≠a seleccionada
    const tipos = obtenerTiposPermitidosVirtualPorCategoria(categoriaSelect.value);
    tipoEventoSelect.innerHTML = `<option value="">Seleccione</option>` +
      tipos.map(t => `<option value="${t}">${t}</option>`).join("");

    // 3) Espacio: no aplica (deshabilitado)
    espacioSelect.value = "";
    espacioSelect.disabled = true;
    espacioSelect.innerHTML = '<option value="">No aplica (evento virtual)</option>';

    // 4) Participantes: habilitado y sin l√≠mite
    participantesInput.disabled = false;
    participantesInput.placeholder = "Ingrese n√∫mero de participantes (sin l√≠mite)";
    participantesInput.removeAttribute('max');

    // 5) Al cambiar la categor√≠a en virtual, refrescar los tipos
    categoriaSelect.onchange = () => {
      const tipos2 = obtenerTiposPermitidosVirtualPorCategoria(categoriaSelect.value);
      tipoEventoSelect.innerHTML = `<option value="">Seleccione</option>` +
        tipos2.map(t => `<option value="${t}">${t}</option>`).join("");
      // Mantener reglas de fechas/horas
      manejarVisibilidadFechaHora();
    };

  } 
   else {
    // Volver a habilitar categor√≠a
    categoriaSelect.disabled = false;

    // Reconstruir tipos seg√∫n categor√≠a actual
    actualizarTipoEvento(tipoEventoSelect.value || "");

    // Espacio vuelve a depender del tipo de evento
    espacioSelect.disabled = false;
    actualizarEspaciosDisponibles(espacioSelect.value || "");

    // Participantes vuelven a depender del espacio
    actualizarCapacidadParticipantes();
  }
}

 // Categor√≠as y tipos PERMITIDOS cuando la modalidad es Virtual
const TIPOS_VIRTUAL = {
  "Eventos Institucionales": [
    "Congresos, seminarios, simposios, encuentros, foros, talleres o jornadas, entre otros.",
    "Socializaci√≥n de resultados de actividades y/o proyectos de vinculaci√≥n e investigaci√≥n",
    "Socializaci√≥n de planes de las unidades organizacionales",
    "Entrega de Reconocimiento por rendimiento acad√©mico"
  ],
  "Eventos Solemnes": [
    "Sesi√≥n Solemne de Aniversario Institucional",
    "Audiencia P√∫blica de Rendici√≥n de Cuentas, dispuesta por el Consejo de Participaci√≥n Ciudadana y Control Social",
    "Aniversario de fundaci√≥n de las facultades",
    "Ceremonia Honoris Causa"
  ]
};

function obtenerCategoriasPermitidasVirtual() {
  return Object.keys(TIPOS_VIRTUAL);
}
function obtenerTiposPermitidosVirtualPorCategoria(cat) {
  return TIPOS_VIRTUAL[cat] || [];
}


// ===== FIN DEL C√ìDIGO A A√ëADIR =====

function manejarVisibilidadFechaHora() {
    const categoria = document.getElementById("categoria").value;
    const tipoEvento = document.getElementById("tipo_evento").value;
    const contenedor = document.getElementById("contenedorFechasHoras");
    
    const campos = [
        document.getElementById("inicio_reserva"),
        document.getElementById("fin_reserva"),
        document.getElementById("hora_inicio"),
        document.getElementById("hora_fin")
    ];

    if (categoria === "Eventos Solemnes" && tipoEvento === "Ceremonias de graduaci√≥n de grado y posgrado") {
        contenedor.style.display = "none";
        campos.forEach(campo => {
            campo.required = false;
            campo.value = "";
        });
    } else {
        contenedor.style.display = "flex";
        campos.forEach(campo => {
            campo.required = true;
        });
    }
}

function mostrarTablaResumen() {
  const tbody = document.getElementById("tablaResumen");
  tbody.innerHTML = eventos.map((e, i) => `
    <tr>
      <td>${e.nombre_evento}</td>
      <td>${e.categoria}</td>
      <td>${e.tipo_evento}</td>
      <td>${e.modalidad || 'Presencial'}</td><!-- NUEVO -->
      <td>${e.espacio || (e.modalidad === 'Virtual' ? 'No aplica' : '')}</td>
      <td>${e.inicio_reserva}</td>
      <td>${e.fin_reserva}</td>
      <td>${e.hora_inicio}</td>
      <td>${e.hora_fin}</td>
      <td>${e.participantes}</td>
      <td>
        <button type="button" class="btn btn-sm btn-warning" onclick="mostrarFormularioDetalle(${i})">Editar</button>
        <button type="button" class="btn btn-sm btn-danger" onclick="eliminarEvento(${i})">Eliminar</button>
      </td>
    </tr>
  `).join("");
}

function eliminarEvento(index) {
  eventos.splice(index, 1);
  mostrarTablaResumen();

  // ===== A√ëADIR ESTA L√ìGICA AQU√ç =====
  // Si la lista de eventos queda vac√≠a, oculta el bot√≥n de enviar.
  if (eventos.length === 0) {
    document.getElementById("contenedorBotonEnviar").style.display = "none";
  }
}

document.getElementById("formularioEvento").addEventListener("submit", async function(e) {
  e.preventDefault();
    
  if (eventos.length === 0) {
      Swal.fire({ icon: "warning", title: "Sin eventos", text: "Debe a√±adir al menos un evento a la lista antes de enviar." });
      return;
  }

  Swal.fire({
    title: 'Enviando...',
    text: 'Se est√° enviando la informaci√≥n, por favor espere.',
    allowOutsideClick: false,
    allowEscapeKey: false,
    didOpen: () => { Swal.showLoading(); }
  });

  const formData = new FormData();
  const nombreDepartamento = $('#departamento').val();
  formData.append("solicitante", document.getElementById("solicitante").value);
  formData.append("departamento", nombreDepartamento); 
  formData.append("correo", document.getElementById("correo").value);

  formData.append("modalidad", document.getElementById("modalidad").value); 

  formData.append("eventos", JSON.stringify(eventos));

  try {
    const res = await fetch(scriptURL, { method: "POST", body: formData });
    const data = await res.json();
    if (data.status === "ok") {
      Swal.fire({ icon: "success", title: "Solicitud enviado", text: "Los eventos han sido registrados" });
      this.reset();
      eventos = [];
      mostrarTablaResumen();
      document.getElementById("detalleEvento").style.display = "none";
       cargarUnidades();
    } else {
      throw new Error(data.message || "No se pudo completar el env√≠o.");
    }
  } catch (err) {
    Swal.fire({ icon: "error", title: "Error", html: err.message });
  }
});
// Inicializa al cargar
document.addEventListener('DOMContentLoaded', () => {
  cargarUnidades();
});
</script>
</body>

</html>
